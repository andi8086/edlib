旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
;MEMORY ..................... LIBRARY ROUTINE rev 001, by Jens-Christian Huus 
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;Memory management routines, like ALLOCATE, DEALLOCATE and SETBLOCK. Refer to 
;each routine for additional information.                                     
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;RETURNS:      CF Set: Screen cleared and error message printed - Abort Main. 
읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸




컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
SEGMENT         Data    PUBLIC 'Data'

MemMessage      db      'MEMORY: $'

MemText         dw      0
                dw      0
                dw      0
                dw      0
                dw      0
                dw      0
                dw      0
                dw      MemError7
                dw      MemError8
                dw      MemError9

MemError7       db      'Memory control blocks destroyed.',10,13,'$'
MemError8       db      'Insufficient memory.',10,13,'$'
MemError8       db      'Invalid memory block address.',10,13,'$'

ENDS
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
SEGMENT         Code    PUBLIC 'Code'


SetBlock:
旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
;Redefines the size of the main program, use this before allocating. Pass the 
;size of memory with X/16 in BX where X is the size in bytes. The ES register 
;points to the segment of the main program - it can be ignored if calling the 
;routine before doing anything else. Otherwise you must load ES with the PSP. 
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;PARAMETERS:   BX = New block size, in paragraphs.                            
;              ES = Segment address of main program.                          
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;RETURNS:      BX = Size of largest available block (If CF set).              
읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
                mov     ah,4ah
                int     21h
                jc      MemError
                ret

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

Allocate:
旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
;Allocates memory with X/16 in BX where X is the size in bytes.               
;                                                                             
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;PARAMETERS:   BX = Block size, in paragraphs.                                
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;RETURNS:      AX = Segment address of allocated memory.                      
;              BX = Size of largest available block (If CF set).              
읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
                mov     ah,48h
		int	21h
                jc      MemError
                ret

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴

DeAllocate:
旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
;Frees previously allocated memory - not needed at the end of your program if 
;using the standard DOS exit (4C00h) as this deallocates automatically.       
쳐컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴캑
;PARAMETERS:   ES = Segment address of memory to be released.                 
읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
                mov     ah,49h
		int	21h
                jc      MemError
                ret

컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
MemError:                                       ;Print error message and exit.
                push    ax bx dx si

                shl     ax,1
                mov     si,ax
                mov     ax,0003h                ;Clear screen.
                int     10h
                mov     ax,Data
                mov     ds,ax
                lea     dx,[MemMessage]
                mov     ah,9
                int     21h
                mov     dx,[MemText+si]
                int     21h
                stc

                pop     si dx bx ax
                ret
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
ENDS
